<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tablero normalizado</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 24px; color: #222; }
        h1 { margin-bottom: 8px; }
        .nav { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .nav a { color: #0b6bcb; text-decoration: none; font-weight: 600; }
        .nav a:hover { text-decoration: underline; }
        .card { border: 1px solid #ddd; padding: 14px 16px; border-radius: 6px; background: #f8f8f8; margin-bottom: 12px; }
        table { border-collapse: collapse; width: 100%; margin-top: 8px; }
        th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; text-align: right; }
        th { background: #f0f0f0; text-align: center; }
        .header { background: #d60000; color: #fff; font-weight: 700; text-align: center; }
        .dest-row { background: #f7f7f7; font-weight: 700; text-align: left; }
        .muted { color: #666; font-size: 12px; }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="/">Inicio</a>
        <a href="/planificacion/normalizar/">Normalizar planificación</a>
        <a href="/salidas/normalizar/">Normalizar salidas</a>
        <a href="/tablero/normalizado/">Tablero</a>
    </nav>

    <h1>Tablero normalizado (plan vs salidas)</h1>

    <form method="get" style="margin-bottom: 12px; display: inline-flex; gap: 8px; align-items: center; flex-wrap: wrap;">
        <label for="start_date">Fecha inicio:</label>
        <input type="date" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}" />
        <label for="origin">Cedis:</label>
        <select id="origin" name="origin">
            <option value="">Todos</option>
            {% for oid, oname in origin_choices %}
                <option value="{{ oid }}" {% if selected_origin == oid %}selected{% endif %}>{{ oname }}</option>
            {% endfor %}
        </select>
        <label><input type="checkbox" name="single_day" value="1" {% if single_day %}checked{% endif %}> Solo este día</label>
        <label for="mode">Ver:</label>
        <select id="mode" name="mode">
            <option value="per" {% if not mode_all %}selected{% endif %}>Por Cedis</option>
            <option value="all" {% if mode_all %}selected{% endif %}>Todos combinados</option>
        </select>
        <button type="submit">Ver 8 días</button>
        <span class="muted">Se muestran 8 días consecutivos desde la fecha seleccionada.</span>
        <button type="submit" name="export" value="csv">Descargar CSV</button>
    </form>

    {% if not dates %}
        <div class="card">No hay datos de planificación o salidas normalizadas.</div>
    {% else %}
        <div class="card" style="overflow-x: auto;">
            {% for origen in table %}
                <table>
                    <thead>
                        <tr class="header">
                            <th style="text-align: left;">{{ origen.origin_name }}</th>
                            {% for d in dates %}
                                <th>{{ d|date:'d/m/Y' }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for destino in origen.destinos %}
                            <tr class="dest-row">
                                <td colspan="{{ dates|length|add:1 }}">{{ destino.name }}</td>
                            </tr>
                            {% for group, cells in destino.groups.items %}
                                <tr>
                                    <td style="text-align: left;">{{ group }}</td>
                                    {% for cell in cells %}
                                        <td>
                                            {% if cell.percent is not None %}
                                                {{ cell.percent }}%
                                            {% else %}
                                                0%
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% empty %}
                                <tr><td colspan="{{ dates|length|add:1 }}">Sin datos para este destino.</td></tr>
                            {% endfor %}
                        {% empty %}
                            <tr><td colspan="{{ dates|length|add:1 }}" class="muted">Sin destinos con salidas para este origen.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div style="height: 12px;"></div>
            {% empty %}
                <div>No hay salidas en el rango.</div>
            {% endfor %}
        </div>
    {% endif %}
</body>
</html>
