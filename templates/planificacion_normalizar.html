<!DOCTYPE html>
<html>
<head>
    <title>Normalizar Planificación</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .summary { display: flex; gap: 16px; margin-bottom: 16px; }
        .card { padding: 12px 16px; border: 1px solid #ddd; border-radius: 6px; background: #f8f8f8; }
        table { border-collapse: collapse; width: 100%; margin-top: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
        th { background: #f0f0f0; text-align: left; }
        .error { color: #b00020; }
        .ok { color: #0a7c2f; }
        .btn { padding: 10px 16px; background: #0a7c2f; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>Normalizar planificación</h1>

    <div class="summary">
        <div class="card">Pendientes: <strong>{{ summary.pending }}</strong></div>
        <div class="card">Normalizados: <strong>{{ summary.ok }}</strong></div>
        <div class="card">Con error: <strong>{{ summary.error }}</strong></div>
        <div class="card">Total crudos: <strong>{{ summary.total }}</strong></div>
    </div>

    <form method="get" style="margin-bottom: 12px; display: inline-flex; gap: 8px; align-items: center;">
        <label for="plan_month">Mes:</label>
        <select id="plan_month" name="plan_month" {% if not months %}disabled{% endif %}>
            {% for m in months %}
                <option value="{{ m|date:'Y-m-d' }}" {% if m == selected_month %}selected{% endif %}>{{ m|date:'Y-m' }}</option>
            {% endfor %}
        </select>
        <button class="btn" type="submit">Ver</button>
    </form>
    {% if not months %}
        <div class="card" style="display: inline-block; margin-left: 8px;">No hay planificaciones cargadas.</div>
    {% elif selected_month %}
        <div class="card" style="display: inline-block; margin-left: 8px;">Normalizando mes: <strong>{{ selected_month }}</strong></div>
    {% endif %}

    <form method="post" style="margin-bottom: 16px;">
        {% csrf_token %}
        <input type="hidden" name="plan_month" value="{{ selected_month }}" />
        <button class="btn" type="submit" {% if summary.pending == 0 and summary.error == 0 %}disabled{% endif %}>
            Normalizar pendientes
        </button>
    </form>

    {% if ran %}
    <div class="card" style="margin-bottom: 16px;">
        <div>Procesados: {{ run_result.processed }}</div>
        <div class="ok">Creados: {{ run_result.created }}</div>
        <div class="ok">Actualizados: {{ run_result.updated }}</div>
        <div class="error">Errores: {{ run_result.errors }}</div>
    </div>
    {% endif %}

    <h2>Pendientes recientes</h2>
    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>ItemCode</th>
                <th>ItemName</th>
                <th>Sucursal texto</th>
                <th>Origen</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for r in pending %}
            <tr>
                <td>{{ r.plan_month }}</td>
                <td>{{ r.item_code }}</td>
                <td>{{ r.item_name }}</td>
                <td>{{ r.sucursal }}</td>
                <td>{{ r.origen_picking }}</td>
                <td>{{ r.normalize_status }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="6">Sin pendientes.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Errores recientes</h2>
    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>ItemCode</th>
                <th>Sucursal texto</th>
                <th>Producto</th>
                <th>Notas</th>
            </tr>
        </thead>
        <tbody>
            {% for r in errors %}
            <tr>
                <td>{{ r.plan_month }}</td>
                <td>{{ r.item_code }}</td>
                <td>{{ r.sucursal }}</td>
                <td>{{ r.item_name }}</td>
                <td class="error">{{ r.normalize_notes }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5">Sin errores.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
